# .github/workflows/weekly-proxy-hunter.yml
name: Weekly Asia ProxyIP Hunter (Smart & Stable)

on:
  schedule:
    - cron: '0 4 * * 0'        # æ¯å‘¨æ—¥ UTC 04:00ï¼ˆåŒ—äº¬æ—¶é—´ä¸­åˆ12ç‚¹ï¼‰
  workflow_dispatch:           # æ”¯æŒæ‰‹åŠ¨è§¦å‘

jobs:
  pipeline:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install geoip2 pandas requests tqdm

      # æ™ºèƒ½åˆ¤æ–­æ˜¯å¦éœ€è¦é‡å»ºæ•°æ®åº“ï¼ˆ7å¤©å†…ä¸é‡å¤å»ºï¼‰
      - name: Check if ASN DB needs update
        id: check_db
        run: |
          DB_FILE="data/ultimate_asn.db"
          MAX_AGE_DAYS=7

          if [ ! -f "$DB_FILE" ]; then
            echo "æ•°æ®åº“ä¸å­˜åœ¨ â†’ éœ€è¦æ„å»º"
            echo "need_build=true" >> $GITHUB_OUTPUT
          else
            file_time=$(git log -1 --format="%at" -- "$DB_FILE" 2>/dev/null || date +%s)
            current_time=$(date +%s)
            age_days=$(( (current_time - file_time) / 86400 ))
            echo "æ•°æ®åº“å¹´é¾„ï¼š$age_days å¤©"
            if [ $age_days -gt $MAX_AGE_DAYS ]; then
              echo "è¶…è¿‡ $MAX_AGE_DAYS å¤© â†’ éœ€è¦æ›´æ–°"
              echo "need_build=true" >> $GITHUB_OUTPUT
            else
              echo "ä»… $age_days å¤© â†’ è·³è¿‡æ„å»º"
              echo "need_build=false" >> $GITHUB_OUTPUT
            fi
          fi

      # åªæœ‰éœ€è¦æ—¶æ‰æ„å»ºæ•°æ®åº“
      - name: Build Ultimate ASN Database
        if: steps.check_db.outputs.need_build == 'true'
        timeout-minutes: 25
        run: python 1_database_builder.py

      # å§‹ç»ˆè¿è¡Œæ‰«æå™¨ï¼ˆç”¨æœ€æ–°æ•°æ®åº“ï¼‰
      - name: Run Asia ProxyIP Scanner
        timeout-minutes: 40
        run: python 2_proxy_scanner.py

      # å®‰å…¨æäº¤ï¼ˆä¼˜åŒ–äº† awk å’Œæ—¥æœŸæ ¼å¼ï¼‰
      - name: Commit & Push Results
        run: |
          git config --global user.name "GitHub Action Hunter"
          git config --global user.email "action@github.com"
          
          git add data/ultimate_asn.db proxyip_real_available.txt
          
          if git diff --quiet --staged; then
            echo "ğŸ‰ æ²¡æœ‰å˜åŒ–ï¼Œæœ¬å‘¨æ”¶æ‰‹ï¼"
          else
            NEW_COUNT=$(git diff --staged --numstat | awk '{sum+=$1+$2} END {print sum}' || echo "0")
            git commit -m "Weekly hunt: +${NEW_COUNT} new real ProxyIP - $(date -u '+%Y-%m-%d %H:%M') UTC"
            git push origin main
            echo "ğŸš€ å·²æäº¤ ${NEW_COUNT} æ¡æ–°æå“ï¼"
          fi
