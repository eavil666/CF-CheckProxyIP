# .github/workflows/weekly-proxy-hunter.yml
name: Weekly ProxyIP Hunter + Release + Telegram

on:
  schedule:
    - cron: '0 4 * * 0'        # æ¯å‘¨æ—¥ UTC 04:00ï¼ˆåŒ—äº¬ä¸­åˆ12ç‚¹ï¼‰
  workflow_dispatch:

jobs:
  hunt-and-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install geoip2 pandas requests tqdm

      - name: Build ASN Database
        run: python 1_database_builder.py

      - name: Run Scanner
        run: python 2_proxy_scanner.py

      - name: Generate Golden List (â‰¤30ms Top 300)
        run: |
          if [ ! -f proxyip_real_available.txt ]; then
            echo "æ— ç»“æœï¼Œè·³è¿‡ç²¾é€‰æ¦œå•"
            exit 0
          fi
          grep -E " [0-9]{1,2}ms | [0-2][0-9]ms " proxyip_real_available.txt | \
            sort -n -k2 | head -300 > golden_300.txt
          echo "ç”Ÿæˆ golden_300.txtï¼ˆ$(wc -l < golden_300.txt) æ¡ï¼‰"

      - name: Create Release + Upload Files
        if: success() && env.NEW_COUNT != '0'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          NEW_COUNT: $(git diff --numstat proxyip_real_available.txt | awk '{print $1}' || echo 0)
        run: |
          TAG="golden-$(date +'%Y%m%d')"
          TITLE="2025 é»„é‡‘ç²¾é€‰æ¦œå•ï¼ˆTop 300ï¼Œâ‰¤30msï¼‰+${{ env.NEW_COUNT }} æ–°å¢"
          
          gh release create "$TAG" \
            golden_300.txt proxyip_real_available.txt \
            --title "$TITLE" \
            --notes "è‡ªåŠ¨ç‹©çŒå®Œæˆï¼æœ¬æ¬¡æ–°å¢ ${{ env.NEW_COUNT }} æ¡çœŸå®å¯ç”¨ ProxyIP"

      - name: Telegram æ¨é€é€šçŸ¥
        if: always()
        run: |
          NEW=$(git diff --numstat proxyip_real_available.txt | awk '{print $1}' || echo 0)
          GOLDEN=$(wc -l < golden_300.txt 2>/dev/null || echo 0)
          
          TEXT="ğŸš€ *Cloudflare ProxyIP ç‹©çŒæŠ¥å‘Š* %0A"
          TEXT+="æ—¥æœŸï¼š$(date -u '+%Y-%m-%d %H:%M') UTC %0A"
          TEXT+="æœ¬æ¬¡æ–°å¢ï¼š*${NEW}* æ¡ %0A"
          TEXT+="ç²¾é€‰æ¦œå•ï¼š*${GOLDEN}* æ¡ï¼ˆâ‰¤30msï¼‰ %0A%0A"
          TEXT+="ğŸ”¥ æœ€å¿« Top 5ï¼š%0A"
          head -5 golden_300.txt | while read line; do
            TEXT+="$(echo $line | cut -d' ' -f1)   $(echo $line | cut -d' ' -f2)%0A"
          done
          TEXT+="%0Aä¸‹è½½åœ°å€ï¼šhttps://github.com/$GITHUB_REPOSITORY/releases/latest"

          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TG_BOT_TOKEN }}/sendMessage" \
            -d chat_id=${{ secrets.TG_CHAT_ID }} \
            -d text="$TEXT" \
            -d parse_mode=Markdown \
            -d disable_web_page_preview=true